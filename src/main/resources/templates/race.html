<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Horse Race</title>
   <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script></head>
<body>

<h3>é¦¬ã‚’è¿½åŠ </h3>
<div id="addHorseArea">
    åå‰: <input type="text" id="horseName">
    è‰²: <input type="color" id="horseColor" value="#ff0000">
    ã‚¹ãƒ”ãƒ¼ãƒ‰: <input type="number" id="horseSpeed" value="100" min="1" max="10">
    è€åŠ›: <input type="number" id="horseStamina" value="100" min="10" max="100">
    emoji: <input type="text" id="horseEmoji" value="ğŸ">
    <button onclick="addHorse()">è¿½åŠ </button>
    <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="statusArea">
    <div id="status">
        <div>
            <h3>ç™»éŒ²æ¸ˆã¿ã®é¦¬</h3>
            <div class="scroll-area">
                <ul id="horseList"></ul>
            </div>
        </div>

        <div>
            <h3>ãƒ¬ãƒ¼ã‚¹çµæœ</h3>
            <div class="scroll-area">
                <ul id="raceResult"></ul>
            </div>
        </div>
    </div>

    <div id="historyArea">
        <div>
            <h3>éå»ã®ãƒ¬ãƒ¼ã‚¹ä¸€è¦§</h3>
            <div class="scroll-area">
                <ul id="raceList"></ul>
            </div>
        </div>
        <div>
            <h3>é¸æŠã—ãŸãƒ¬ãƒ¼ã‚¹ã®çµæœ</h3>
            <div class="scroll-area">
                <ul id="raceDetail"></ul>
            </div>
        </div>
    </div>
</div>

<div id="raceArea">
    <div id="raceTrack">
        <canvas id="raceCanvas" width="1000" height="300" style="border:1px solid #000;"></canvas><br>
        <button id="startBtn" onclick="startRace()">ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
        <button id="resetBtn" onclick="resetRace()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div id="bet">
        <h3>ğŸ è³­ã‘é¦¬</h3>
        <div id="money">æ‰€æŒé‡‘: 1000å††</div>
        <div id="betArea">
            <select id="betHorseSelect">
                <option value="">-- é¦¬ã‚’é¸ã¶ --</option>
            </select>
            <div>
                é‡‘é¡: <input type="number" id="betAmount" value="100">
                <button id="betBtn" onclick="placeBet()">è³­ã‘ã‚‹</button>
            </div>
        </div>
        <div id="betResult">
            <p id="betStatus" style="font-weight: bold;"></p>
        </div>

    </div>
</div>

<style>
    #addHorseArea {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    #horseEmoji,
    #betAmount{
        width: 50px; /* è®¾ç½® emoji è¾“å…¥æ¡†çš„å®½åº¦ */
    }

    #addHorseArea {
        margin-bottom: 1rem;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    #addHorseArea input{
        min-width: 100px; /* è®¾ç½®è¾“å…¥æ¡†çš„æœ€å°å®½åº¦ */
    }

    #statusArea {
        display: flex;
        justify-content: start;
        gap: 8rem;
        align-items: flex-start;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    /* å†…éƒ¨ä¸¤ä¸ªåŒºå—å¹¶æ’ */
    #status, #historyArea {
        display: flex;
        gap: 2rem;
    }

    /* æ¯ä¸ªå°åˆ—è¡¨å— */
    #status > div,
    #historyArea > div {
        width: 300px;
        height: 250px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    h3 {
        margin: 0;
        padding: 0.5rem;
        font-size: 1rem;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ccc;
    }

    .scroll-area {
        flex: 1;
        list-style: none;
        overflow-y: auto;
        overflow-x: auto;
        padding: 0.5rem;
        white-space: nowrap;
    }

    ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    #raceList li {
        cursor: pointer;
        color: deepskyblue;
        text-decoration: underline;
    }

    #raceArea {
        display: flex;
        align-content: start;
        justify-content: start;
        gap: 3rem;
    }

    #bet {
        height: 300px;
        min-width: 350px;
        max-width: 350px;
        display: flex;
        overflow-y: auto;
        overflow-x: auto;
        flex-direction: column;
        border: 1px solid #ccc;
        gap: 0.5rem;
        border-radius: 5px;
    }

    #betArea {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        justify-content: center;
        padding: 5px;
    }

    #money {
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-align: center;
    }

    #betResult {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-weight: bold;
        font-size: 1.8rem;
        word-wrap: anywhere;
    }
</style>

<script>
    // åœ¨ script åŒºåŸŸå¼€å§‹å¤„æ·»åŠ 
    let horses = [];
    var HORSE_PATH = "/horse";
    const resultList = document.getElementById("raceResult");
    let currentRaceId = null;
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const canvas = document.getElementById("raceCanvas");
    const ctx = canvas.getContext("2d");
    let currentBet = null;
    let balance = 1000; // åˆå§‹é‡‘é¢

    // é¡µé¢åŠ è½½æ—¶ä»æœåŠ¡å™¨è·å–é©¬åŒ¹
    $(document).ready(function() {
       $.ajax({
            url: HORSE_PATH + '/race/horses',
            type: 'GET',
            success: function(data) {
                console.log('æˆåŠŸè·å–æ•°æ®:', data);
                horses = data;
                resetHorsePositions();
                updateHorseList();
                drawTrack();
                loadRaceList();
                updateResultListBeforeRace();
            },
            error: function(error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
            }
       });
    });

    function hexToRgb(hex) {
        // å»æ‰ # å·
        hex = hex.replace(/^#/, '');
        if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
        }
        const bigint = parseInt(hex, 16);
        return {
            r: (bigint >> 16) & 255,
            g: (bigint >> 8) & 255,
            b: bigint & 255
        };
    }

    function updateBalanceDisplay() {
        document.getElementById("money").textContent = `æ‰€æŒé‡‘: ${balance}å††`;
    }

    function updateResultListBeforeRace() {
        resultList.innerHTML = "";
        horses.forEach((h, i) => {
            const li = document.createElement("li");
            li.textContent = `${i + 1}ä½: ${h.emoji} ${h.horseName}ï¼ˆ- ç§’ï¼‰`;
            resultList.appendChild(li);
        });
    }


    // ä¿®æ”¹ addHorse å‡½æ•°
    function addHorse() {
        const horseName = $('#horseName').val();
        const color = $('#horseColor').val();
        const speed = parseInt($('#horseSpeed').val(), 10);
        const stamina = parseInt($('#horseStamina').val(), 10);
        const emoji = $('#horseEmoji').val();

        if (!horseName) {
            alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        // å‘æœåŠ¡å™¨ä¿å­˜æ–°é©¬åŒ¹
        $.ajax({
            url: HORSE_PATH + '/race/horses',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ horseName: horseName, color: color, speed: speed, stamina: stamina, emoji: emoji}),
            success: function(data) {
                // é‡æ–°è·å–åˆ—è¡¨
                $.ajax({
                    url: HORSE_PATH + '/race/horses',
                    type: 'GET',
                    success: function(data) {
                        horses = data;
                        resetRace();
                        updateHorseList();
                        console.log("âœ… å·²é‡æ–°åŠ è½½æ‰€æœ‰é©¬åŒ¹");
                    }
                });
            },
            error: function(error) {
                console.error('ä¿å­˜é©¬åŒ¹å¤±è´¥:', error);
            }
        });
    }

    // ä¿®æ”¹åˆ é™¤é©¬åŒ¹çš„é€»è¾‘
    function deleteHorse(id) {
        console.log("åˆ é™¤é©¬åŒ¹ ID:", id);
        $.ajax({
            url: HORSE_PATH + `/race/horses/delete/${id}`,
            type: 'POST',
            success: function() {
                horses = horses.filter(h => h.horseId !== id);
                resetRace();
                // æ›´æ–°é©¬åŒ¹åˆ—è¡¨
                updateHorseList();
                console.log("é©¬åŒ¹åˆ—è¡¨å·²æ›´æ–°");
            },
            error: function(error) {
                console.error('åˆ é™¤é©¬åŒ¹å¤±è´¥:', error);
            }
        });
    }

    // ä¿®æ”¹ updateHorseList å‡½æ•°
    function updateHorseList() {
        const list = document.getElementById("horseList");
        list.innerHTML = "";
        horses.forEach((h) => {
            const li = document.createElement("li");

            // åˆ›å»ºåˆ é™¤æŒ‰é’®å¹¶æ”¾åœ¨æœ€å‰é¢
            const delBtn = document.createElement("button");
            delBtn.textContent = "âŒ";
            delBtn.onclick = () => deleteHorse(h.horseId);
            delBtn.style.marginRight = "10px"; // æ·»åŠ å³ä¾§é—´è·

            // å…ˆæ·»åŠ æŒ‰é’®ï¼Œå†æ·»åŠ æ–‡æœ¬
            li.appendChild(delBtn);

            // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹å¹¶æ·»åŠ 
            const textNode = document.createTextNode(
                `${h.emoji} ${h.horseId} ${h.horseName} (é€Ÿåº¦:${h.speed}, è€åŠ›:${h.stamina})`
            );
            li.appendChild(textNode);
            list.appendChild(li);
        });
        updateBetHorseOptions();
    }

    function updateBetHorseOptions() {
        const select = document.getElementById("betHorseSelect");
        select.innerHTML = '<option value="">-- é¦¬ã‚’é¸ã¶ --</option>';
        horses.forEach(h => {
            const opt = document.createElement("option");
            opt.value = h.horseId;
            opt.textContent = `${h.emoji || "ğŸ"} ${h.horseName}`;
            select.appendChild(opt);
        });
    }

    function placeBet() {
        const horseId = parseInt($('#betHorseSelect').val());
        const amount = parseInt($('#betAmount').val());
        const horse = horses.find(h => h.horseId === horseId);

        if (!horseId || !horse || amount <= 0) {
            $('#betStatus').text("âš ï¸ é¦¬ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        if (amount > balance) {
            $('#betStatus').text(`âš ï¸ æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ç¾åœ¨ ${balance}å††`);
            return;
        }

        // æ‰£é™¤é‡‘é¢
        balance -= amount;
        updateBalanceDisplay();

        currentBet = {
            horseId: horse.horseId,
            horseName: horse.horseName,
            emoji: horse.emoji,
            amount: amount
        };

        $('#betStatus').text(`ğŸ¯ ${horse.emoji || "ğŸ"} ${horse.horseName} ã« ${amount}å†† ã‚’è³­ã‘ã¾ã—ãŸ`);
        document.getElementById("betBtn").disabled = true;
    }

    function drawTrack() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç”»ç»ˆç‚¹çº¿
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(canvas.width - 20, 0);
        ctx.lineTo(canvas.width - 20, canvas.height);
        ctx.stroke();

        // æ‹–å°¾æ¸ç»†ï¼Œå¹¶ä¸”è½¨è¿¹ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…æ¶ˆå¤±
        horses.forEach(horse => {
            const maxTrail = 30; // æœ€å¤šä¿ç•™ 30 ä¸ªè½¨è¿¹ç‚¹
            if (horse.path.length > maxTrail) {
                horse.path = horse.path.slice(horse.path.length - maxTrail); // åªä¿ç•™æœ€æ–° 30 ä¸ª
            }

            const len = horse.path.length;
            for (let i = 0; i < len; i++) {
                const p = horse.path[i];

                // è¶Šé è¿‘ç°åœ¨ï¼Œè¶Šå¤§è¶Šä¸é€æ˜
                const progress = (i + 1) / len;  // 0.0 ~ 1.0
                const radius = 3 * progress;     // åŠå¾„é€æ¸å˜å°
                const alpha = progress.toFixed(2); // é€æ˜åº¦å¢åŠ 

                const rgb = hexToRgb(horse.color || "#888888");
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;

                ctx.beginPath();
                ctx.arc(p.x + 15, p.y + 15, radius, 0, Math.PI * 2);
                ctx.fill();
            }

            // ğŸ´ ç»˜åˆ¶é©¬æœ¬ä½“å’Œåå­—
            ctx.font = "28px serif";
            ctx.fillText(horse.emoji || "ğŸ", horse.x, horse.y + 20);
            ctx.font = "14px Arial";
            ctx.fillStyle = horse.color;
            ctx.fillText(horse.horseName, horse.x, horse.y - 5);
        });
    }

    function loadRaceList() {
        $.ajax({
            url: HORSE_PATH + '/race/list',
            type: 'GET',
            success: function(races) {
                const raceList = document.getElementById("raceList");
                raceList.innerHTML = "";
                races.forEach(r => {
                    const li = document.createElement("li");
                    li.textContent = `Race ${r.raceId} - ${new Date(r.raceTime).toLocaleString()}`;
                    li.onclick = () => loadRaceDetail(r.raceId);
                    raceList.appendChild(li);
                });
            },
            error: function(err) {
                console.error("âŒ è·å–æ¯”èµ›åˆ—è¡¨å¤±è´¥:", err);
            }
        });
    }

    function loadRaceDetail(raceId) {
        $.ajax({
            url: HORSE_PATH + `/race/results/${raceId}`,
            type: 'GET',
            success: function(results) {
                const raceDetail = document.getElementById("raceDetail");
                raceDetail.innerHTML = "";
                results
                    .sort((a, b) => a.horseRank - b.horseRank)
                    .forEach(r => {
                        const li = document.createElement("li");
                        li.textContent = `${r.horseRank}ä½: ${r.emoji} ${r.horseName}ï¼ˆ${r.finishTime} ç§’ï¼‰`;
                        raceDetail.appendChild(li);
                    });
            },
            error: function(err) {
                console.error("âŒ è·å–æ¯”èµ›ç»“æœå¤±è´¥:", err);
            }
        });
    }

    function resetHorsePositions() {
        startBtn.disabled = false;
        const totalHorses = horses.length;
        const padding = 20;
        const trackHeight = canvas.height - padding * 2;
        const spacing = trackHeight / totalHorses;

        horses.forEach((h, i) => {
            h.x = 0;
            h.y = padding + i * spacing;
            h.finished = false;
            h.finishTime = null;
            h.path = []; // ğŸŒˆ åˆå§‹åŒ–è½¨è¿¹æ•°ç»„
        });
    }


    function resetRace() {
        resetHorsePositions();
        drawTrack();
    }

    function startRace() {
        // å¦‚æœå¼€å§‹æŒ‰é’®è¢«ç¦ç”¨ï¼Œåˆ™ä¸æ‰§è¡Œæ¯”èµ›
        if (startBtn.disabled) return;

        // æŒ‰äº†å¼€å§‹æŒ‰é’®åï¼Œç¦ç”¨é‡ç½®æŒ‰é’®å’Œå¼€å§‹æŒ‰é’®ä»¥åŠä¸‹æ³¨æŒ‰é’®
        startBtn.disabled = true;
        resetBtn.disabled = true;
        document.getElementById("betBtn").disabled = true; // ç¦ç”¨ä¸‹æ³¨æŒ‰é’®

        // ç¬¬ä¸€æ­¥ï¼šå…ˆå‘åç«¯æ³¨å†Œæ¯”èµ›ï¼Œè·å– raceId
        $.ajax({
            url: HORSE_PATH + '/race',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),  // ç©ºå¯¹è±¡å³å¯ï¼Œå› ä¸º race_time æœ‰é»˜è®¤å€¼
            success: function(raceId) {
                console.log("âœ… æ¯”èµ›åˆ›å»ºæˆåŠŸ ID:", raceId);
                currentRaceId = raceId;
                runRace();
            },
            error: function(err) {
                console.error("âŒ æ¯”èµ›åˆ›å»ºå¤±è´¥:", err);
            }
        });
    }

    function runRace() {
        let frameCount = 0;

        horses.forEach(h => {
            const base = h.speed * 0.1 + h.stamina * 0.01;
            const randomness = Math.random() * 0.5 + 0.5;
            h.speed = base * randomness; // åŸºç¡€å€¼ä¹˜éšæœºå› å­
            h.finished = false;
            h.finishTime = null;
        });

        function animate() {
            frameCount++;
            horses.forEach(h => {
                if (!h.finished) {
                    // ğŸƒ æ­£åœ¨æ¯”èµ›ä¸­
                    h.speed += (Math.random() - 0.5) * 0.3;
                    h.speed = Math.max(0.5, Math.min(h.speed, 2.5));
                    h.x += h.speed;

                    if (frameCount % 2 === 0) {
                        h.path.push({ x: h.x, y: h.y });
                    }

                    if (h.x + 50 >= canvas.width) {
                        h.finished = true;
                        h.finishTime = frameCount;
                    }
                } else {
                    // ğŸ’¤ åˆ°è¾¾ç»ˆç‚¹åï¼Œè½¨è¿¹å¼€å§‹æ…¢æ…¢æ¶ˆå¤±
                    if (h.path.length > 0 && frameCount % 2 === 0) {
                        h.path.shift();
                    }
                }
            });

            drawTrack();

            const results = [...horses].sort((a, b) => {
                if (a.finished && b.finished) return a.finishTime - b.finishTime;
                if (a.finished) return -1;
                if (b.finished) return 1;
                return b.x - a.x;
            });

            let resultHTML = "";
            results.forEach((h, i) => {
                const time = h.finished ? (h.finishTime / 60).toFixed(2) : (frameCount / 60).toFixed(2);
                resultHTML += `<li>${i + 1}ä½: ${h.emoji} ${h.horseName}ï¼ˆ${time} ç§’ï¼‰${h.finished ? 'âœ…' : ''}</li>`;
            });
            resultList.innerHTML = resultHTML;

            // èµŒé©¬
            if (horses.every(h => h.finished) && currentBet) {
                const winner = results[0];
                const win = winner.horseId === currentBet.horseId;

                if (win) {
                    // å€ç‡ä¸ºå‚åŠ é©¬çš„æ•°é‡
                    const totalHorses = horses.length;
                    const prize = currentBet.amount * totalHorses;
                    balance += prize;
                    $('#betStatus').text(`ğŸ‰ çš„ä¸­ï¼${currentBet.emoji || "ğŸ"} ${currentBet.horseName} ãŒ 1ä½ï¼ è³é‡‘ã¯ ${prize}å†† ã§ã™ï¼`);
                } else {
                    $('#betStatus').text(`ğŸ˜¢ ã¯ãšã‚Œ... 1ä½ã¯ ${winner.emoji || "ğŸ"} ${winner.horseName}`);
                }

                // æ›´æ–°ä½™é¢æ˜¾ç¤º
                updateBalanceDisplay();
                currentBet = null; // æ¸…é™¤æœ¬æ¬¡ä¸‹æ³¨
            }

            // âœ… æ‰€æœ‰é©¬éƒ½å†²çº¿åï¼Œæ‰“åŒ…å¹¶å‘é€æˆç»©
            if (horses.every(h => h.finished)) {
                resetBtn.disabled = false;
                document.getElementById("betBtn").disabled = false;

                const resultPayload = results.map((h, i) => ({
                    raceId: currentRaceId,
                    horseId: h.horseId,
                    emoji: h.emoji,
                    horseName: h.horseName,
                    finishTime: (h.finishTime / 60).toFixed(2),
                    horseRank: i + 1
                }));

                $.ajax({
                    url: HORSE_PATH + "/race/results",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(resultPayload),
                    success: () => {console.log("âœ… æˆç»©å·²ä¿å­˜");
                        loadRaceList();
                        // updateResultListBeforeRace();
                    },
                    error: (e) => console.error("âŒ ä¿å­˜æˆç»©å¤±è´¥", e)
                });
            } else {
                requestAnimationFrame(animate);
            }
        }

        requestAnimationFrame(animate);
    }

    // è°ƒç”¨åç«¯çš„åˆ é™¤æ¯”èµ›å’Œç»“æœæ¥å£ï¼Œåˆ é™¤æ‰€æœ‰è®°å½•
    function resetGame() {
        $.ajax({
            url: HORSE_PATH + '/race/delete',
            type: 'POST',
            success: function() {
                console.log("âœ… æ¸¸æˆå·²é‡ç½®");
                loadRaceList();
                loadRaceDetail(0);
            },
            error: function(error) {
                console.error('é‡ç½®æ¸¸æˆå¤±è´¥:', error);
            }
        })
    }

    // åˆå›è¡¨ç¤º
    resetHorsePositions();
    updateHorseList();
    drawTrack();
</script>

</body>
</html>